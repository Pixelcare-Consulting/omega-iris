datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

model User {
    id            String    @id @default(cuid())
    code          Int       @unique @default(autoincrement())
    username      String    @unique
    fname         String
    lname         String
    email         String    @unique
    emailVerified DateTime?
    password      String    @default("")
    roleCode      Int
    isOnline      Boolean   @default(false)
    isActive      Boolean   @default(true)
    location      String?
    lastIpAddress String?
    lastSignin    DateTime?
    customerCode  String?
    supplierCode  String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    accounts Account[]
    profile  Profile?
    role     Role      @relation(fields: [roleCode], references: [code])

    projectGroupPics           ProjectGroupPic[]           @relation(name: "User-ProjectGroupPic")
    projectIndividualPics      ProjectIndividualPic[]      @relation(name: "User-ProjectIndividualPic")
    projectIndividualCustomers ProjectIndividualCustomer[] @relation(name: "User-ProjectIndividualCustomer")
    workOrders                 WorkOrder[]
    projectItemDateReceivedBy  ProjectItem[]               @relation()
}

model Role {
    id          String  @id @default(cuid())
    code        Int     @unique @default(autoincrement())
    name        String
    key         String  @unique
    description String? @default("")

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    users           User[]
    rolePermissions RolePermission[]
}

model Permission {
    id             String   @id @default(uuid())
    code           String   @unique
    name           String
    description    String?  @default("")
    isParent       Boolean  @default(false)
    parentId       String?
    allowedActions String[] //* default actions 'view', 'create', 'edit', 'delete

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    parent          Permission?      @relation(name: "Permission-Permission", fields: [parentId], references: [id])
    children        Permission[]     @relation("Permission-Permission")
    rolePermissions RolePermission[]
}

model RolePermission {
    roleId       String
    permissionId String
    actions      String[] @default([])

    role       Role       @relation(fields: [roleId], references: [id], onUpdate: Cascade, onDelete: Cascade)
    permission Permission @relation(fields: [permissionId], references: [id], onUpdate: Cascade, onDelete: Cascade)

    @@unique([roleId, permissionId])
    @@index([actions], type: Gin)
}

model Profile {
    id       String @id @default(cuid())
    code     Int    @unique @default(autoincrement())
    userCode Int    @unique

    details Json?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    user User @relation(fields: [userCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
}

model Account {
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

    @@id([provider, providerAccountId])
}

//* event notify
model Notification {
    id         String  @id @default(cuid())
    code       Int     @unique @default(autoincrement())
    title      String
    message    String  @db.Text
    link       String?
    entityType String? //* user, project, item, etc
    entityCode Int?
    entityId   String?
    metaData   Json? //* contains additional data

    //* audience fields
    userCodes  Int[]    @default([])
    roleCodes  Int[]    @default([])
    roleKeys   String[] @default([])
    isGlobal   Boolean  @default(false)
    isInternal Boolean  @default(false)

    //* blocking fields
    excludeUserCodes Int[]    @default([])
    excludeRoleCodes Int[]    @default([])
    excludeRoleKeys  String[] @default([])

    createdAt DateTime  @default(now())
    expiresAt DateTime? //* should expire 1month  //* can be use to handle auto deletion of notification via cron job 
    createdBy String?

    receipts NotificationReceipt[]

    //* Gin - Generalized Inverted Index (designed for fast and efficient querying of values such as Arrays, JSONB)
    @@index([userCodes], type: Gin)
    @@index([roleCodes], type: Gin)
    @@index([roleKeys], type: Gin)
}

//* event user interaction
model NotificationReceipt {
    id               String @id @default(cuid())
    code             Int    @unique @default(autoincrement())
    notificationCode Int

    userCode  Int
    readAt    DateTime?
    deletedAt DateTime?

    notification Notification @relation(fields: [notificationCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([notificationCode, userCode])
    @@index([userCode, readAt, deletedAt])
}

model BusinessPartner {
    id       String  @id @default(cuid())
    code     Int     @unique @default(autoincrement())
    isActive Boolean @default(true)

    //* sap fields
    CardCode   String  @unique
    CardName   String
    CardType   String
    CntctPrsn  String?
    CurrName   String?
    CurrCode   String?
    GroupCode  Int?
    GroupName  String?
    GroupNum   Int?
    PymntGroup String?
    Phone1     String?
    ShipToDef  String?
    BillToDef  String?
    AcctType   String?
    CmpPrivate String?

    syncStatus String @default("pending") //* pending, synced 

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    addresses                  Address[]
    contacts                   Contact[]
    projectIndividualSuppliers ProjectIndividualSupplier[] @relation(name: "BusinessPartner-ProjectIndividualSupplier")
}

model Address {
    id                   String  @id @default(cuid())
    CardCode             String
    AddressName          String
    AddrType             String
    Street               String?
    Address2             String?
    Address3             String?
    StreetNo             String?
    BuildingFloorRoom    String?
    Block                String?
    City                 String?
    ZipCode              String?
    County               String?
    CountryCode          String?
    CountryName          String?
    StateCode            String?
    StateName            String?
    GlobalLocationNumber String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    businessPartner BusinessPartner @relation(fields: [CardCode], references: [CardCode], onUpdate: Cascade, onDelete: Cascade)

    @@unique([CardCode, AddressName, AddrType])
    @@index([CardCode])
}

model Contact {
    id          String  @id @default(cuid())
    CardCode    String
    ContactName String
    FirstName   String?
    LastName    String?
    Title       String?
    Position    String?
    Phone1      String?
    Phone2      String?
    MobilePhone String?
    Email       String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    businessPartner BusinessPartner @relation(fields: [CardCode], references: [CardCode], onUpdate: Cascade, onDelete: Cascade)

    @@unique([CardCode, ContactName])
    @@index([CardCode])
}

model Item {
    //TODO: remove manufacturerPartNumber, manufacturer, description - instead use sap fields
    id        String  @id @default(cuid())
    code      Int     @unique @default(autoincrement())
    thumbnail String?
    notes     String?
    isActive  Boolean @default(true)

    //* sap fields
    ItemCode   String   @unique
    ItemName   String?
    FirmCode   Int?
    FirmName   String?
    ItmsGrpCod Int?
    ItmsGrpNam String?
    Price      Decimal?

    syncStatus String @default("pending") //* pending, synced 

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectItems           ProjectItem[]
    itemWarehouseInventory ItemWarehouseInventory[]
}

model ItemWarehouseInventory {
    id            String  @id @default(cuid())
    code          Int     @unique @default(autoincrement())
    warehouseCode Int
    itemCode      Int
    isLocked      Boolean @default(false)
    inStock       Int     @default(0)
    committed     Int     @default(0)
    ordered       Int     @default(0)
    available     Int     @default(0)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    warehouse Warehouse @relation(fields: [warehouseCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    item      Item      @relation(fields: [itemCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([warehouseCode, itemCode])
    @@index([warehouseCode])
    @@index([itemCode])
}

model Warehouse {
    id                   String  @id @default(cuid())
    code                 Int     @unique @default(autoincrement())
    name                 String
    description          String?
    isActive             Boolean @default(true)
    isDefault            Boolean @default(false)
    isNettable           Boolean @default(false)
    isEnableBinLocations Boolean @default(false)

    address1          String?
    address2          String?
    address3          String?
    streetPoBox       String?
    streetNo          String?
    block             String?
    buildingFloorRoom String?
    zipCode           String?
    city              String?
    county            String?
    countryRegion     String?
    state             String?
    federalTaxId      String?
    gln               String?
    taxOffice         String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    itemInventories ItemWarehouseInventory[]
    projectItems    ProjectItem[]
}

model ProjectGroup {
    id          String  @id @default(cuid())
    code        Int     @unique @default(autoincrement())
    name        String  @unique
    description String?
    isActive    Boolean @default(true)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectIndividuals ProjectIndividual[] @relation()
    projectGroupPics   ProjectGroupPic[]   @relation(name: "ProjectGroup-ProjectGroupPic")
}

model ProjectGroupPic {
    id               String @id @default(cuid())
    projectGroupCode Int
    userCode         Int

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectGroup ProjectGroup @relation(name: "ProjectGroup-ProjectGroupPic", fields: [projectGroupCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    user         User         @relation(name: "User-ProjectGroupPic", fields: [userCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([projectGroupCode, userCode])
    @@index([projectGroupCode])
    @@index([userCode])
}

model ProjectIndividual {
    id          String  @id @default(cuid())
    code        Int     @unique @default(autoincrement())
    name        String  @unique
    groupCode   Int?
    description String?
    isActive    Boolean @default(true)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectGroup ProjectGroup? @relation(fields: [groupCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    projectIndividualPics      ProjectIndividualPic[]      @relation(name: "ProjectIndividual-ProjectIndividualPic")
    projectIndividualCustomers ProjectIndividualCustomer[] @relation(name: "ProjectIndividual-ProjectIndividualCustomer")
    projectIndividualSuppliers ProjectIndividualSupplier[] @relation(name: "ProjectIndividual-ProjectIndividualSupplier")
    items                      ProjectItem[]
    workOrders                 WorkOrder[]
}

//* NOTE: Item must be synced already in SAP before it can be selected for project item 
model ProjectItem {
    id                    String @id @default(cuid())
    code                  Int    @unique @default(autoincrement())
    itemCode              Int
    projectIndividualCode Int

    warehouseCode   Int?
    partNumber      String?
    dateCode        String?
    countryOfOrigin String?
    lotCode         String?
    palletNo        String?
    packagingType   String?
    spq             String?
    dateReceived    DateTime?
    dateReceivedBy  Int?
    cost            Decimal?  @default(0)
    stockIn         Decimal?  @default(0)
    stockOut        Decimal?  @default(0)
    totalStock      Decimal?  @default(0)
    siteLocation    String?
    subLocation2    String?
    subLocation3    String?
    notes           String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    item               Item              @relation(fields: [itemCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    projectIndividual  ProjectIndividual @relation(fields: [projectIndividualCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    warehouse          Warehouse?        @relation(fields: [warehouseCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    dateReceivedByUser User?             @relation(fields: [dateReceivedBy], references: [code], onUpdate: Cascade, onDelete: Cascade)

    workOrderItems WorkOrderItem[]

    @@index([projectIndividualCode])
    @@index([itemCode])
}

model ProjectIndividualCustomer {
    id                    String @id @default(cuid())
    projectIndividualCode Int
    userCode              Int

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectIndividual ProjectIndividual @relation(name: "ProjectIndividual-ProjectIndividualCustomer", fields: [projectIndividualCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    user              User              @relation(name: "User-ProjectIndividualCustomer", fields: [userCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([projectIndividualCode, userCode])
    @@index([projectIndividualCode])
    @@index([userCode])
}

model ProjectIndividualSupplier {
    id                    String @id @default(cuid())
    projectIndividualCode Int
    supplierCode          String

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectIndividual ProjectIndividual @relation(name: "ProjectIndividual-ProjectIndividualSupplier", fields: [projectIndividualCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    businessPartner   BusinessPartner   @relation(name: "BusinessPartner-ProjectIndividualSupplier", fields: [supplierCode], references: [CardCode], onUpdate: Cascade, onDelete: Cascade)

    @@unique([projectIndividualCode, supplierCode])
    @@index([projectIndividualCode])
    @@index([supplierCode])
}

model ProjectIndividualPic {
    id                    String @id @default(cuid())
    projectIndividualCode Int
    userCode              Int

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectIndividual ProjectIndividual @relation(name: "ProjectIndividual-ProjectIndividualPic", fields: [projectIndividualCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    user              User              @relation(name: "User-ProjectIndividualPic", fields: [userCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([projectIndividualCode, userCode])
    @@index([projectIndividualCode])
    @@index([userCode])
}

model WorkOrder {
    id                      String  @id @default(cuid())
    code                    Int     @unique @default(autoincrement())
    projectIndividualCode   Int
    userCode                Int
    status                  String
    isInternal              Boolean @default(false)
    billingAddrCode         String?
    shippingAddrCode        String?
    comments                String?
    customerPo              String?
    salesOrderCode          Int?
    purchaseOrderCode       Int?
    isAlternativeAddr       Boolean @default(false)
    alternativeBillingAddr  String?
    alternativeShippingAddr String?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?

    projectIndividual ProjectIndividual @relation(fields: [projectIndividualCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    user              User              @relation(fields: [userCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    workOrderItems         WorkOrderItem[]
    workOrderStatusUpdates WorkOrderStatusUpdate[]

    @@index([projectIndividualCode])
    @@index([userCode])
}

model WorkOrderStatusUpdate {
    id            String  @id @default(cuid())
    code          Int     @unique @default(autoincrement())
    workOrderCode Int
    prevStatus    String
    currentStatus String
    comments      String?
    trackingNum   String?

    createdAt DateTime @default(now())
    createdBy String?

    workOrder WorkOrder @relation(fields: [workOrderCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@index([workOrderCode])
}

model WorkOrderItem {
    workOrderCode   Int
    projectItemCode Int
    qty             Decimal? @default(0)
    isDelivered     Boolean  @default(false)

    workOrder   WorkOrder   @relation(fields: [workOrderCode], references: [code], onUpdate: Cascade, onDelete: Cascade)
    projectItem ProjectItem @relation(fields: [projectItemCode], references: [code], onUpdate: Cascade, onDelete: Cascade)

    @@unique([workOrderCode, projectItemCode])
    @@index([workOrderCode])
    @@index([projectItemCode])
}

model FileAttachment {
    id          String @id @default(cuid())
    code        Int    @unique @default(autoincrement())
    refCode     Int? //* unique code of a entity
    modulelName String
    name        String
    type        String
    size        Int
    path        String

    uploadedAt DateTime @default(now())
    updatedAt  DateTime @default(now()) @updatedAt
    uploadedBy String?
    updatedBy  String?

    @@unique([modulelName, name])
    @@index([modulelName])
}

model Settings {
    id       String  @id @default(cuid())
    roleCode Int?
    code     Int     @unique @default(autoincrement())
    data     Json //* JSON containing all settings
    isGlobal Boolean @default(false)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?
}

//* synchronization metadata table
model SyncMeta {
    id          String   @id @default(uuid())
    code        String   @unique
    description String?
    lastSyncAt  DateTime @default(now())

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt
    deletedAt DateTime?
    createdBy String?
    updatedBy String?
    deletedBy String?
}

//* add model system logs
